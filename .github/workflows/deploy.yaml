name: Deploy to VPS (manual)

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Nama app/binary (default: server)"
        required: false
        default: "server"
        type: string
      deploy_path:
        description: "Folder deploy di VPS (default: /opt/server)"
        required: false
        default: "/opt/server"
        type: string
      systemd_service:
        description: "Nama systemd service untuk restart (default: server)"
        required: false
        default: "server"
        type: string
      port:
        description: "SSH port"
        required: false
        default: "22"
        type: string

permissions:
  contents: read

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build (linux/amd64)
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: "0"
          VERSION: ${{ github.sha }}
          APP_NAME: ${{ inputs.app_name }}
          OUT_DIR: bin
        run: |
          set -euo pipefail
          make build
          ls -lah bin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-linux-amd64
          path: |
            bin/*
          if-no-files-found: error

  deploy:
    needs: build-linux-amd64
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-linux-amd64
          path: ./artifact

      - name: Prepare deploy file
        run: |
          set -euo pipefail
          # build output dari Makefile: bin/<app_name>
          chmod +x "./artifact/${{ inputs.app_name }}" || true
          ls -lah ./artifact

      - name: Upload binary to VPS (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "./artifact/${{ inputs.app_name }}"
          target: "/tmp/deploy-${{ inputs.app_name }}"

      - name: Deploy & restart service (SSH)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ inputs.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail

            APP="${{ inputs.app_name }}"
            DEPLOY_PATH="${{ inputs.deploy_path }}"
            SERVICE="${{ inputs.systemd_service }}"

            sudo mkdir -p "${DEPLOY_PATH}"
            sudo chown -R "$(whoami)":"$(whoami)" "${DEPLOY_PATH}" || true

            # taruh binary baru
            sudo mv "/tmp/deploy-${APP}/artifact/${APP}" "${DEPLOY_PATH}/${APP}.new" || sudo mv "/tmp/deploy-${APP}/${APP}" "${DEPLOY_PATH}/${APP}.new" || true
            sudo chmod +x "${DEPLOY_PATH}/${APP}.new"

            # atomic swap
            if [ -f "${DEPLOY_PATH}/${APP}" ]; then
              sudo mv "${DEPLOY_PATH}/${APP}" "${DEPLOY_PATH}/${APP}.bak"
            fi
            sudo mv "${DEPLOY_PATH}/${APP}.new" "${DEPLOY_PATH}/${APP}"

            # restart service
            sudo systemctl daemon-reload || true
            sudo systemctl restart "${SERVICE}"
            sudo systemctl --no-pager status "${SERVICE}" -l || true

            echo "Deploy selesai: ${DEPLOY_PATH}/${APP}"